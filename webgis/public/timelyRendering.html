<!doctype html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>OpenLayers 即时渲染</title>

    <meta charset="utf-8" />

    <link rel="stylesheet" href="./cdn/ol.css" />

    <script src="./cdn/ol.js"></script>

    <style>
      * {
        padding: 0;
        margin: 0;
        font-size: 14px;
        font-family: "微软雅黑";
      }

      html,
      body {
        width: 100%;
        height: 100%;
      }

      #map {
        position: absolute;
        top: 50px;
        bottom: 0;
        width: 100%;
        background: #e0eced;
      }

      #top-content {
        position: absolute;
        width: 100%;
        height: 50px;
        line-height: 50px;
        background: linear-gradient(135deg, #ff00cc, #ffcc00, #00ffcc, #ff0066);
        color: #fff;
        text-align: center;
        font-size: 32px;
      }

      #top-content span {
        font-size: 32px;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
  </body>
</html>

<script>
  //地图投影坐标系
  const projection = ol.proj.get("EPSG:3857");
  const TDTTOKEN = "3ae5c8d194b04200a60fd8ab69b05365";
  //==============================================================================// //============================天地图服务参数简单介绍==============================// //================================vec：矢量图层==================================// //================================img：影像图层==================================// //================================cva：注记图层==================================// //======================其中：_c表示经纬度投影，_w表示球面墨卡托投影================// //==============================================================================//
  const TDTImgLayer = new ol.layer.Tile({
    title: "天地图影像图层",
    source: new ol.source.XYZ({
      url:
        "https://t0.tianditu.gov.cn/img_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=" +
        TDTTOKEN,
      attibutions: "天地图影像描述",
      crossOrigin: "anoymous",
      wrapX: false,
    }),
  });
  const TDTImgCvaLayer = new ol.layer.Tile({
    title: "天地图影像注记图层",
    source: new ol.source.XYZ({
      url:
        "https://t0.tianditu.gov.cn/cia_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=" +
        TDTTOKEN,
      attibutions: "天地图注记描述",
      crossOrigin: "anoymous",
      wrapX: false,
    }),
  });

  const map = new ol.Map({
    target: "map",
    loadTilesWhileInteracting: true,
    view: new ol.View({
      center: [101.485106, 25.008643],
      zoom: 5,
      worldsWrap: false,
      minZoom: 1,
      maxZoom: 20,
      projection: "EPSG:4326",
    }),
    layers: [
      TDTImgLayer,
      new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: `https://t0.tianditu.gov.cn/cta_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cta&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=${TDTTOKEN}`,
        }),
      }),
    ], // 地图默认控件
    controls: ol.control.defaults.defaults({
      zoom: false,
      attribution: true,
      rotate: true,
    }),
  });

  const circle = new ol.style.Circle({
    radius: 5,
    fill: new ol.style.Fill({
      color: "yellow",
    }),
  });
  const circleStyle = new ol.style.Style({
    image: circle,
  }); // 随机创建1000个几何对象

  const geoNum = 10000;
  const geomes = [];
  for (let i = 0; i < geoNum; i++) {
    const lng = 75 + 90 * Math.random();
    const lat = -30 + 65 * Math.random();
    geomes.push(new ol.geom.Point([lng, lat]));
  }

  TDTImgLayer.on("postrender", (evt) => {
    const vectorContext = ol.render.getVectorContext(evt);
    for (let i = 0; i < geoNum; i++) {
      const flex = ol.easing.upAndDown(Math.pow((geoNum - i) / geoNum, 0.15));
      if (flex < 0.1) {
        continue;
      }
      circle.setOpacity(flex);
      circle.setScale(flex);
      vectorContext.setStyle(circleStyle);
      vectorContext.drawGeometry(geomes[i]);
    }

    const lng = 85 + 90 * Math.random();
    const lat = -30 + 65 * Math.random();
    geomes.push(new ol.geom.Point([lng, lat]));

    geomes.shift();
    map.render();
  });
</script>
